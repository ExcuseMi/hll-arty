<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>HLL Artillery Range Assistant</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
    <style>
        :root {
            --primary: #4CAF50;
            --primary-hover: #45a049;
            --accent: #117e21d5;
            --accent-hover: #10b729d5;
            --background: #2a2a2a;
            --surface: #333;
            --text: #ffffff;
            --text-secondary: #ccc;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: var(--text);
        }

        .container {
            background: var(--background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: var(--surface);
        }

        /* Faction Selector */
        .faction-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .faction-group {
            background: var(--surface);
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            text-align: center;
        }

        .faction-group h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .faction-list {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .faction-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .faction-group.active {
            background: var(--accent);
            border-color: var(--accent-hover);
        }

        /* Conversion Display */
        .conversion {
            font-size: 28px;
            font-weight: bold;
            padding: 25px;
            margin: 20px 0;
            background: linear-gradient(145deg, var(--accent), var(--accent-hover));
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            text-align: center;
        }

        /* Buttons */
        .control-button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }

        .control-button:disabled {
            background: #777;
            cursor: not-allowed;
        }

        .control-button.active {
            background: var(--accent-hover);
        }

        #calculateBtn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
        }

        #calculateBtn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #calculateBtn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #clearHistoryBtn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #clearHistoryBtn:hover {
            background: #cc0000;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #clearHistoryBtn:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Input Section */
        .input-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--surface);
            border-radius: 4px;
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            align-items: stretch;
        }

        input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 4px;
            background: var(--surface);
            color: white;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* History Section */
        .history {
            margin-top: 20px;
            background: var(--surface);
            padding: 15px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-content {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }

        .history-content::-webkit-scrollbar {
            width: 8px;
        }

        .history-content::-webkit-scrollbar-track {
            background: #444;
            border-radius: 4px;
        }

        .history-content::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .history-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #444;
            transition: background 0.3s;
            position: relative;
        }

        .history-item:hover {
            background: #444;
        }

        .history-faction {
            font-weight: bold;
            color: var(--accent);
            text-align: left;
        }

        .history-calculation {
            text-align: center;
            color: var(--text-secondary);
        }

        .history-mils {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1em;
            text-shadow: 0 0 5px rgba(0, 188, 212, 0.3);
        }

        .history-timestamp {
            text-align: right;
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }

        .history-item:hover::after {
            content: attr(data-timestamp);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            pointer-events: none;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--surface);
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        .settings-panel.collapsed {
            max-height: 50px;
            padding: 0;
        }

        .settings-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            background: transparent;
            border-radius: 4px;
            position: relative;
            z-index: 2;
        }

        .settings-toggle h3 {
            margin: 0;
        }

        .settings-toggle::after {
            content: '▼';
            transition: transform 0.3s;
            color: var(--accent);
        }

        .settings-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        .settings-content {
            transition: opacity 0.3s ease;
        }

        .settings-panel.collapsed .settings-content {
            opacity: 0;
            pointer-events: none;
        }

        .settings-group {
            margin: 15px 0;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .settings-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .slider-container {
            position: relative;
            padding: 15px 0;
            flex: 1;
            min-width: 200px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #444;
            border-radius: 5px;
            outline: none;
            margin: 15px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            background: var(--accent);
            border-radius: 5px;
        }

        input[type="range"]::-moz-range-track {
            height: 8px;
            background: var(--accent);
            border-radius: 5px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .checkbox-group {
            position: relative;
            padding-left: 30px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-group input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 20px;
            background-color: var(--surface);
            border: 2px solid var(--accent);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .checkbox-group:hover input~.checkmark {
            border-color: var(--accent-hover);
        }

        .checkbox-group input:checked~.checkmark {
            background-color: var(--accent);
            border-color: var(--accent);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .checkbox-group input:checked~.checkmark:after {
            display: block;
        }

        /* Voice Info Section */
        .voice-info {
            background: var(--surface);
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .voice-info h3 {
            color: var(--accent);
            margin-bottom: 10px;
        }

        .browser-support {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .browser-item {
            background: var(--surface);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .supported {
            color: var(--accent);
        }

        .unsupported {
            color: #ff4444;
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-panel #clearHistoryBtn {
            display: none;
        }

        .disclaimer {
            margin-top: 30px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--accent);
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .disclaimer strong {
            color: var(--accent);
            font-weight: bold;
        }

        .disclaimer p {
            margin: 0;
        }

        a:hover img {
            opacity: 0.8;
            transform: scale(1.05);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .object-cover {
            -o-object-fit: cover;
            object-fit: cover;
        }

        .rounded-md {
            border-radius: .375rem;
        }

        .w-12 {
            width: 3rem;
        }

        .h-12 {
            height: 3rem;
        }

        img,
        video {
            max-width: 100%;
            height: auto;
        }

        img,
        svg,
        video,
        canvas,
        audio,
        iframe,
        embed,
        object {
            display: block;
            vertical-align: middle;
        }

        .title-container {
            display: flex;
            align-items: center;
            /* Vertically center the logo with the title */
            gap: 10px;
            /* Space between the title and the logo */
            margin-bottom: 20px;
            /* Adjust spacing as needed */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
        }

        /* Optional hover effect */
        a:hover img {
            opacity: 0.8;
            transform: scale(1.05);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header with title and logo -->
        <div class="header">
            <h1>Hell Let Loose Artillery Range Assistant</h1>
            <a href="https://discord.gg/the-circle" target="_blank" rel="noopener noreferrer">
                <img alt="The Circle Logo" class="h-12 w-12 rounded-md object-cover" src="images/circle-640.png" />
            </a>
        </div>
        <div class="calculator">
            <div class="control-panel">
                <button class="control-button" id="startBtn">Start Voice</button>
                <button class="control-button" disabled id="stopBtn">Stop Voice</button>

                <button class="control-button" id="enableNotificationsBtn">Enable Notifications</button>
            </div>
            <div class="status" id="status">Status: Not listening</div>

            <div class="faction-selector">
                <div class="faction-group active" id="usFaction">
                    <h3>⭐ US Forces</h3>
                    <div class="faction-list">155MM HOWITZER M114</div>
                </div>
                <div class="faction-group" id="germanFaction">
                    <h3>⚔️ German Forces</h3>
                    <div class="faction-list">150MM HOWITZER SFH 18</div>
                </div>
                <div class="faction-group" id="russianFaction">
                    <h3>🇷🇺 Russian Forces</h3>
                    <div class="faction-list">M122MM HOWITZER 1938 (M-30)</div>
                </div>
                <div class="faction-group" id="britishFaction">
                    <h3>🇬🇧 British Forces</h3>
                    <div class="faction-list">QF 25-POUNDER</div>
                </div>
            </div>
            <div class="input-section">
                <h3>Enter Distance</h3>
                <div class="input-group">
                    <input id="metersInput" max="1600" min="100" placeholder="Enter distance in meters" type="number">
                    <button id="calculateBtn" class="control-button">Calculate</button>
                </div>
            </div>

            <div class="conversion" id="conversion">Waiting for input...</div>

            <div class="history">
                <div class="history-header">
                    <h3>Calculation History</h3>
                    <button class="control-button" id="clearHistoryBtn">Clear History</button>
                </div>
                <div class="history-content" id="historyList">
                    <!-- Example history item -->
                    <div class="history-item" data-timestamp="2023-10-01T12:00:00Z">
                        <span class="history-faction">⭐ US Forces</span>
                        <span class="history-calculation">400m = <span class="history-mils">1200 mils</span></span>
                        <span class="history-timestamp">2 minutes ago</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-panel">
            <div class="settings-toggle" onclick="toggleSettings()">
                <h3>Audio Settings</h3>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <label class="checkbox-group">
                        <input id="audioEnabled" type="checkbox">
                        <span class="checkmark"></span>
                        Audio Enabled
                    </label>
                </div>
                <div class="settings-group">
                    <label class="checkbox-group">
                        <input id="radioNoiseEnabled" type="checkbox">
                        <span class="checkmark"></span>
                        Enable Radio Noise
                    </label>
                </div>
                <div class="settings-row">
                    <div class="settings-group slider-container">
                        <label>Volume: <span class="slider-value" id="volumeValue">100</span>%</label>
                        <input id="volumeSlider" max="100" min="0" type="range" value="100">
                        <div class="slider-labels">
                            <span>0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="voice-info">
            <h3>Voice Recognition Information</h3>
            <p>Voice commands work in the background even when alt-tabbed.</p>
            <div class="browser-support">
                <div class="browser-item">
                    <strong>Chrome</strong><br>
                    <span class="supported">✓ Fully Supported</span>
                </div>
                <div class="browser-item">
                    <strong>Edge</strong><br>
                    <span class="supported">✓ Fully Supported</span>
                </div>
                <div class="browser-item">
                    <strong>Safari</strong><br>
                    <span class="unsupported">✗ Limited Support</span>
                </div>
                <div class="browser-item">
                    <strong>Firefox</strong><br>
                    <span class="unsupported">✗ Not Supported</span>
                </div>
            </div>
            <div class="commands">
                <h3>Voice Commands:</h3>
                <p>1. Set faction: "<strong>faction russian / russian forces</strong>", "<strong>faction british /
                        british forces</strong>" or "<strong>faction US / US forces</strong>" or "<strong>faction
                        Germany / German forces</strong>"</p>
                <p>2. Calculate: Say a number followed by "meters" (e.g., "<strong>400 (meters)</strong>"). Saying four
                    zero zero works as well.</p>
                <p>3. Repeat: Say "<strong>repeat mils</strong>" to hear the last calculation.</p>
                <p>4. Previous: Say "<strong>previous mils</strong>" to hear the second-to-last calculation.</p>
                <p>5. Stop: Say "<strong>stop transmission</strong>".</p>

                <p><strong>Note:</strong> For best results, use Chrome or Edge with a clear microphone</p>
            </div>
        </div>
        <div class="disclaimer">
            <p>
                <strong>Disclaimer:</strong> This tool is a fan-made project and is not affiliated with, endorsed by, or
                associated with Black Matter, Team17, or the <em>Hell Let Loose</em> franchise. All trademarks, logos,
                and images are the property of their respective owners. This tool is provided for educational and
                entertainment purposes only.
            </p>
        </div>
    </div>

    <script>
        const FACTION_DATA = {
            'us': {
                icon: '⭐',
                voice: 'us_artillery',
                name: 'U.S.'
            },
            'german': {
                icon: '⚔️',
                voice: 'german_artillery',
                name: 'Germany'
            },
            'british': {
                icon: '🇬🇧',
                phrase: 'Artillery standing by, sir',
                voice: 'british_artillery',
                name: 'U.K.'
            },
            'russian': {
                icon: '🇷🇺',
                phrase: 'Comrade, artillery ready',
                voice: 'russian_artillery',
                name: 'Russia'
            }
        };
        class MilitaryAudioPlayer {
            constructor() {
                this.voice = 'us_artillery'; // Default voice
                this.digitCache = new Map(); // Cache for digit audio
                this.phraseCache = new Map(); // Cache for phrase audio
                this.basePath = 'audio'; // Base path for audio files
                this.radioStatic = new Audio('audio/effects/radio_noise.mp3'); // Radio static effect
                this.radioStatic.volume = 0.1; // Lower volume for static (reduced from 0.2)
                this.radioStatic.loop = true; // Loop the static noise
                this.volume = 1; // Default volume
                this.isPlaying = false; // Track if audio is playing
                this.useStaticNoise = true; // Whether to use static noise
                this.audioQueue = []; // Queue for managing audio playback
            }

            /**
             * Set whether to use static noise.
             * @param {boolean} enabled - Whether to enable static noise.
             */
            setUseStaticNoise(enabled) {
                this.useStaticNoise = enabled;
            }

            /**
             * Set the volume for all audio.
             * @param {number} volume - Volume level (0-100).
             */
            setVolume(volume) {
                this.volume = volume / 100;
                this.radioStatic.volume = 0.1 * this.volume; // Adjust static volume relative to main volume
            }

            /**
             * Set the current voice and preload all audio files for that voice.
             * @param {string} voice - The voice to set (e.g., 'us_artillery', 'german_artillery').
             */
            async setVoice(voice) {
                this.voice = voice;
                await this.preloadDigits();
                await this.preloadPhrases();
            }

            /**
             * Preload all digit audio files for the current voice.
             */
            async preloadDigits() {
                const digits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'mils'];
                for (const digit of digits) {
                    await this.loadAudio(`${this.basePath}/${this.voice}/digits/${digit}.mp3`, this.digitCache);
                }
            }

            /**
             * Preload all phrase audio files for the current voice.
             */
            async preloadPhrases() {
                const phrases = [
                    'startup', 'faction_selected', 'stop_response', 'repeat', 'previous',
                    'calculating', 'coordinates_received', 'invalid_distance', 'out_of_range', 'microphone_error'
                ];
                for (const phrase of phrases) {
                    await this.loadAudio(`${this.basePath}/${this.voice}/phrases/${phrase}.mp3`, this.phraseCache);
                }
            }

            /**
             * Load an audio file and cache it.
             * @param {string} path - The path to the audio file.
             * @param {Map} cache - The cache to store the audio in.
             */
            async loadAudio(path, cache) {
                return new Promise((resolve, reject) => {
                    if (!cache.has(path)) {
                        const audio = new Audio(path);
                        audio.addEventListener('canplaythrough', () => {
                            cache.set(path, audio);
                            resolve();
                        }, { once: true });
                        audio.addEventListener('error', () => {
                            reject(new Error(`Failed to load audio: ${path}`));
                        }, { once: true });
                    } else {
                        resolve();
                    }
                });
            }

            /**
             * Play a digit or phrase with optional radio static.
             * @param {string} type - The type of audio ('digit' or 'phrase').
             * @param {string} key - The key for the audio (e.g., '0', 'startup').
             */
            async playAudio(type, key) {
                const cache = type === 'digit' ? this.digitCache : this.phraseCache;
                const path = `${this.basePath}/${this.voice}/${type}s/${key}.mp3`;

                if (!cache.has(path)) {
                    try {
                        await this.loadAudio(path, cache);
                    } catch (error) {
                        console.error(error);
                        return;
                    }
                }

                const audio = cache.get(path);
                audio.volume = this.volume;

                // Play radio static if enabled and not already playing
                if (this.useStaticNoise && !this.isPlaying) {
                    this.radioStatic.currentTime = 0;
                    this.radioStatic.play();
                    this.isPlaying = true;
                }

                // Play the audio
                return new Promise((resolve) => {
                    audio.addEventListener('ended', () => {
                        resolve();
                    }, { once: true });
                    audio.play();
                });
            }

            /**
             * Play a sequence of digits followed by "mils".
             * @param {number} mils - The mils value to play.
             */
            async playMils(mils) {
                const digits = String(mils).split('');

                // Play each digit sequentially with minimal delay
                for (const digit of digits) {
                    await this.playAudio('digit', digit);
                    await this.delay(50); // Reduced delay between digits for smoother playback
                }

                // Play "mils"
                await this.playAudio('phrase', 'over');

                // Stop the radio static after a short delay (if enabled)
                if (this.useStaticNoise) {
                    setTimeout(() => {
                        this.radioStatic.pause();
                        this.isPlaying = false;
                    }, 500); // Delay before stopping static to avoid abrupt cut-off
                }
            }

            /**
             * Play a phrase.
             * @param {string} phrase - The phrase to play (e.g., 'startup', 'faction_selected').
             */
            async playPhrase(phrase) {
                try {
                    await this.playAudio('phrase', phrase);

                    // Stop the radio static after the phrase is done (if enabled)
                    if (this.useStaticNoise) {
                        setTimeout(() => {
                            this.radioStatic.pause();
                            this.isPlaying = false;
                        }, 150); // Delay before stopping static to avoid abrupt cut-off
                    }
                } catch (error) {
                    console.error('Error playing phrase:', error);
                }
            }

            /**
             * Delay for a specified number of milliseconds.
             * @param {number} ms - The delay in milliseconds.
             */
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        const audioPlayer = new MilitaryAudioPlayer();
        audioPlayer.setUseStaticNoise(false);
        // Set voice based on faction
        function setVoiceForFaction(faction) {
            audioPlayer.setVoice(FACTION_DATA[faction].voice);
        }
        let currentFaction = 'us';

        let calculationHistory = [];
        let micPermissionGranted = false;
        let minMeters = 100;
        let maxMeters = 1600;
        const audioSettings = {
            enabled: true,
            volume: 1
        };
        function initSettings() {
            const savedSettings = localStorage.getItem('audioSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('audioEnabled').checked = settings.enabled;
                document.getElementById('radioNoiseEnabled').checked = settings.useStaticNoise;
                document.getElementById('volumeSlider').value = settings.volume * 100;
                audioPlayer.setVolume(settings.volume * 100);
                audioPlayer.setUseStaticNoise(settings.useStaticNoise); // Apply radio noise setting
                updateSliderValues();
            }
        }

        function saveSettings() {
            const settings = {
                enabled: document.getElementById('audioEnabled').checked,
                useStaticNoise: document.getElementById('radioNoiseEnabled').checked,
                volume: parseFloat(document.getElementById('volumeSlider').value) / 100
            };
            localStorage.setItem('audioSettings', JSON.stringify(settings));
            audioPlayer.setUseStaticNoise(settings.useStaticNoise); // Update radio noise setting
            localStorage.setItem('currentFaction', currentFaction);
            localStorage.setItem('audioEnabled', JSON.stringify(audioEnabled));
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));

        }

        // Update checkbox initialization
        const audioEnabledCheckbox = document.getElementById('audioEnabled');
        audioEnabledCheckbox.checked = audioSettings.enabled;

        // Add event listener for the new checkbox
        audioEnabledCheckbox.addEventListener('change', function () {
            audioSettings.enabled = this.checked;
            saveSettings();
        });

        function updateSliderValues() {
            const volume = document.getElementById('volumeSlider').value;
            document.getElementById('volumeValue').textContent = volume;
            audioPlayer.setVolume(volume);
        }
        const standardConversion = (meters) => {
            const A = 1001.465;
            const B = -0.2371;
            return Math.round(A + (B * meters));
        };

        const russianConversion = (meters) => {
            const A = 1120;
            const B = 21.33;
            const L = 100;
            return Math.round(A - (((meters / L) - 1) * B));
        };

        const britishConversion = (meters) => {
            const m = -0.1773;
            const b = 550.69;
            return Math.round(m * meters + b);
        };

        function calculateMils(meters) {
            if (isNaN(meters) || meters < minMeters || meters > maxMeters) return null;

            let mils;
            if (currentFaction === 'russian') {
                mils = russianConversion(meters);
            } else if (currentFaction === 'british') {
                mils = britishConversion(meters);
            } else {
                mils = standardConversion(meters);
            }

            document.getElementById('conversion').textContent = `${meters} meters = ${mils} mils`;
            addToHistory(meters, mils, currentFaction);
            speakMils(mils);
            return mils;
        }
        // Load settings and history from localStorage
        function loadSettings() {
            const savedFaction = localStorage.getItem('currentFaction');
            const savedAudioEnabled = localStorage.getItem('audioEnabled');
            const savedHistory = localStorage.getItem('calculationHistory');

            if (savedFaction) currentFaction = savedFaction;
            if (savedAudioEnabled) audioEnabled = JSON.parse(savedAudioEnabled);
            if (savedHistory) calculationHistory = JSON.parse(savedHistory);

            updateFactionUI(currentFaction);
            try {
                updateHistoryUI();
            } catch (e) {
                console.error("Error during updateHistoryUI", e);
            }
        }



        // Clear history
        function clearHistory() {
            calculationHistory = [];
            updateHistoryUI();
            saveSettings();
        }

        // Update updateFactionUI function
        function updateFactionUI(faction) {
            document.getElementById('usFaction').classList.remove('active');
            document.getElementById('germanFaction').classList.remove('active');

            document.getElementById('russianFaction').classList.remove('active');
            document.getElementById('britishFaction').classList.remove('active');

            if (faction === 'us') {
                document.getElementById('usFaction').classList.add('active');
            } else if (faction === 'german') {
                document.getElementById('germanFaction').classList.add('active');
            } else if (faction === 'russian') {
                document.getElementById('russianFaction').classList.add('active');
            } else if (faction === 'british') {
                document.getElementById('britishFaction').classList.add('active');
            }
            setVoiceForFaction(faction);
        }

        function getRelativeTime(timestamp) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - new Date(timestamp)) / 1000);

            if (diffInSeconds < 60) {
                return `${diffInSeconds} second${diffInSeconds === 1 ? '' : 's'} ago`;
            } else if (diffInSeconds < 3600) {
                const diffInMinutes = Math.floor(diffInSeconds / 60);
                return `${diffInMinutes} minute${diffInMinutes === 1 ? '' : 's'} ago`;
            } else if (diffInSeconds < 86400) {
                const diffInHours = Math.floor(diffInSeconds / 3600);
                return `${diffInHours} hour${diffInHours === 1 ? '' : 's'} ago`;
            } else {
                const diffInDays = Math.floor(diffInSeconds / 86400);
                return `${diffInDays} day${diffInDays === 1 ? '' : 's'} ago`;
            }
        }
        function toggleSettings() {
            const panel = document.querySelector('.settings-panel');
            const toggle = document.querySelector('.settings-toggle');
            panel.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }


        function getFullDateTime(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const formatter = new Intl.DateTimeFormat(navigator.language, {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            return formatter.format(date);
        }
        function updateHistoryUI() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = calculationHistory.map(item => `
            <div class="history-item" data-timestamp="${getFullDateTime(item.timestamp)}">
                <span class="history-faction">${getFactionIcon(item.faction)} ${getFactionName(item.faction)}</span>
                <span class="history-calculation">
                    ${item.meters}m = <span class="history-mils">${item.mils} mils</span>
                </span>
                <span class="history-timestamp">${getRelativeTime(item.timestamp)}</span>
            </div>
        `).join('');
        }

        // Update the addToHistory function
        function addToHistory(meters, mils, faction) {
            const timestamp = new Date().toISOString();

            calculationHistory.unshift({
                meters,
                mils,
                faction,
                timestamp
            });

            if (calculationHistory.length > 10) calculationHistory.pop();
            updateHistoryUI();
            saveSettings();
        }


        function updateHistoryTimestamps() {
            const historyItems = document.querySelectorAll('.history-item');
            historyItems.forEach(item => {
                const timestamp = item.getAttribute('data-timestamp');
                const relativeTime = getRelativeTime(timestamp);
                item.querySelector('.history-timestamp').textContent = relativeTime;
            });
        }

        // Initialize the interval for updating timestamps
        setInterval(updateHistoryTimestamps, 30000); // Update every minute


        function getFactionIcon(faction) {
            return FACTION_DATA[faction].icon;
        }
        function getFactionName(faction) {
            return FACTION_DATA[faction].name;
        }
        async function speakMils(mils) {
            await audioPlayer.playMils(mils);
        }
        // Request microphone permission
        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                micPermissionGranted = true;
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (err) {
                console.error('Microphone permission denied:', err);
                document.getElementById('status').textContent = 'Status: Microphone access denied';
                document.getElementById('startBtn').disabled = true;
                return false;
            }
        }

        // Update button states
        function updateButtonStates(isListening) {
            document.getElementById('startBtn').disabled = isListening;
            document.getElementById('stopBtn').disabled = !isListening;
        }

        // Setup keyboard input
        document.getElementById('calculateBtn').addEventListener('click', () => {
            const meters = parseInt(document.getElementById('metersInput').value);
            calculateMils(meters);
        });

        document.getElementById('metersInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const meters = parseInt(e.target.value);
                calculateMils(meters);
            }
        });

        // Faction selection
        document.getElementById('usFaction').addEventListener('click', () => {
            factionChange('us');
        });
        document.getElementById('germanFaction').addEventListener('click', () => {
            factionChange('german');
        });

        document.getElementById('russianFaction').addEventListener('click', () => {
            factionChange('russian');
        });

        document.getElementById('britishFaction').addEventListener('click', () => {
            factionChange('british');
        });



        // Clear history button
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            clearHistory();
        });
        async function speakFactionSelected(faction) {
            await audioPlayer.playPhrase('faction_selected');
        }
        function factionChange(team) {
            const teamLower = team.toLowerCase();
            if (teamLower === 'russian') {
                currentFaction = 'russian';
                updateFactionUI('russian');
                if (audioEnabled) {
                    speakFactionSelected('russian');
                }
            } else if (teamLower === 'british' || ['uk', 'common wealth'].includes(teamLower)) {
                currentFaction = 'british';
                updateFactionUI('british');
                if (audioEnabled) {
                    speakFactionSelected('russian');
                }
            } else if (teamLower === 'us' || ['us', 'america', 'united states'].includes(teamLower)) {
                currentFaction = 'us';
                updateFactionUI('us');
                if (audioEnabled) {
                    speakFactionSelected('us');
                }
            } else if (teamLower === 'german' || ['germany', 'axis'].includes(teamLower)) {
                currentFaction = 'german';
                updateFactionUI('german');
                if (audioEnabled) {
                    speakFactionSelected('german');
                }
            }
            saveSettings();

        }
        // Voice recognition setup
        if (annyang) {
            const commands = {
                'stop transmission': async () => {
                    await stopListening();
                },
               'end transmission': async () => {
                    await stopListening();
                },
                'repeat *followup': function (followup) {
                    followupLower = followup.toLowerCase();
                    if (['mils','mills', 'distance'].includes(followupLower)) {
                        console.log('Repeat command triggered');
                        if (calculationHistory.length > 0) {
                            const lastMils = calculationHistory[0].mils;
                            console.log('Last mils:', lastMils);
                            speakMils(lastMils);
                        } else {
                            console.log('No history to repeat');
                        }
                    }
                },
                'previous *followup': function (followup) {
                    followupLower = followup.toLowerCase();
                    if (['mils','mills', 'distance'].includes(followupLower)) {

                        console.log('Previous command triggered');
                        if (calculationHistory.length > 1) {
                            const previousMils = calculationHistory[1].mils;
                            console.log('Previous mils:', previousMils);
                            speakMils(previousMils);
                        } else {
                            console.log('Not enough history for previous');
                        }
                    }
                },
                'faction *team': function (team) {
                    factionChange(team);
                },
                '*team forces': function (team) {
                    factionChange(team);
                },
                ':number meter': function (number) {
                    const meters = parseInt(number);
                    calculateMils(meters);
                },
                ':number meters': function (number) {
                    const meters = parseInt(number);
                    calculateMils(meters);
                },
                ':number': function (number) {
                    const meters = parseInt(number);
                    calculateMils(meters);
                }
            };
            annyang.addCommands(commands);
            annyang.addCallback('result', function (phrases) {
                console.log('Recognized phrases:', phrases);
            });
            document.getElementById('startBtn').addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Stop the stream immediately
                    micPermissionGranted = true;
                    annyang.start({ autoRestart: true, continuous: true });
                    document.getElementById('status').textContent = 'Status: Listening';
                    updateButtonStates(true);
                    setTimeout(async () => { await audioPlayer.playPhrase('startup'); }, 500);

                } catch (err) {
                    console.error('Microphone permission denied:', err);
                    document.getElementById('status').textContent = 'Status: Microphone access denied';
                    document.getElementById('startBtn').disabled = true;
                }
            });
            async function stopListening() {
                // Stop annyang after the phrase is fully played
                annyang.abort();
                document.getElementById('status').textContent = 'Status: Not listening';
                updateButtonStates(false);
                setTimeout(async () => { await audioPlayer.playPhrase('stop_response'); }, 500);
            }
            // Stop button handler
            document.getElementById('stopBtn').addEventListener('click', async () => {
                await stopListening();

            });
            document.getElementById('audioEnabled').addEventListener('change', saveSettings);
            document.getElementById('volumeSlider').addEventListener('input', () => {
                updateSliderValues();
                saveSettings();
            });

            // Error handling
            annyang.addCallback('error', function (err) {
                console.error('Annyang error:', err);
                if (err.error === 'network') {
                    document.getElementById('status').textContent = 'Status: Network error - check connection';
                } else if (err.error === 'audio') {
                    document.getElementById('status').textContent = 'Status: Audio error - check microphone';
                    micPermissionGranted = false;
                } else if (err.error === 'aborted') {
                    document.getElementById('status').textContent = 'Status: Recognition stopped';
                    updateButtonStates(false);
                    return;
                } else {
                    document.getElementById('status').textContent = 'Status: Error occurred';
                }
                updateButtonStates(false);

            });

            // Handle successful start
            annyang.addCallback('start', async () => {
                micPermissionGranted = true;
                document.getElementById('status').textContent = 'Status: Listening';
                updateButtonStates(true);

            });
        } else {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = 'Voice recognition not available';
        }
        // Initialize on load
        initSettings();

        // Set initial button states
        updateButtonStates(false);

        // Load settings on page load
        loadSettings();

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function () {
            if (document.hidden) {
                if (annyang && annyang.isListening()) {
                    document.getElementById('status').textContent = 'Status: Running in background';
                }
            } else {
                if (annyang && annyang.isListening()) {
                    document.getElementById('status').textContent = 'Status: Listening';
                    updateButtonStates(true);
                } else {
                    document.getElementById('status').textContent = 'Status: Not listening';
                    updateButtonStates(false);
                }
            }
        });
        document.getElementById('enableNotificationsBtn').addEventListener('click', () => {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        alert('Notifications enabled! You will now receive updates.');
                    } else {
                        alert('Notifications permission denied. You can enable it later in your browser settings.');
                    }
                });
            } else {
                alert('This browser does not support notifications.');
            }
        });

        // Only request notification permission once
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    document.getElementById('enableNotificationsBtn').style.visibility = 'hidden';
                } else {
                    alert('Notifications permission denied. You can enable it later in your browser settings.');
                }
            });
        } else if ('Notification' in window && Notification.permission === 'granted') {
            document.getElementById('enableNotificationsBtn').style.visibility = 'hidden';
        }

    </script>
</body>

</html>