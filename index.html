<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLL Range Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
	<script src="https://code.responsivevoice.org/responsivevoice.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #333;
        }
        .faction-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .faction-group {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .faction-group.active {
            background: #4CAF50;
        }
        .faction-group h3 {
            margin: 0 0 10px 0;
        }
        .faction-list {
            font-size: 0.9em;
            color: #ccc;
        }
        .conversion {
            font-size: 24px;
            padding: 20px;
            margin: 10px 0;
            border-radius: 4px;
            background: #555;
            text-align: center;
        }
		.control-button {
			background: #4CAF50;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 4px;
			cursor: pointer;
			margin: 5px;
			transition: background 0.3s;
		}

		.control-button:disabled {
			background: #777;
			cursor: not-allowed;
		}

		.control-button.active {
			background: #45a049;
		}
        .history {
            margin-top: 20px;
            background: #333;
            padding: 15px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .commands {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
		input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: white;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-section {
            margin: 20px 0;
            padding: 20px;
            background: #333;
            border-radius: 4px;
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .voice-info {
            background: #444;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .voice-info h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .browser-support {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .browser-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .supported {
            color: #4CAF50;
        }

        .unsupported {
            color: #ff4444;
        }

       .settings-panel {
            background: #333;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .settings-group {
            margin: 15px 0;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        .settings-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .slider-container {
            flex: 1;
            min-width: 200px;
        }

        .slider-value {
            display: inline-block;
            width: 40px;
            text-align: right;
        }
	</style>
</head>
<body>
    <div class="container">
        <div class="calculator">
            <h1>Hell Let Loose Artillery Calculator</h1>
            
			<div class="control-panel">
				<button id="startBtn" class="control-button">Start Voice</button>
				<button id="stopBtn" class="control-button" disabled>Stop Voice</button>
				<button id="clearHistoryBtn" class="control-button">Clear History</button>
			</div>
			<div class="container">
				<div class="settings-panel">
					<h3>Audio Settings</h3>
					<div class="settings-group">
						<label>
							<input type="checkbox" id="audioEnabled"> Audio Enabled
						</label>
					</div>
					
					<div class="settings-row">
						<div class="settings-group">
							<label>Voice:</label>
							<select id="voiceSelect"></select>
						</div>
						
						<div class="settings-group slider-container">
							<label>Volume: <span class="slider-value" id="volumeValue">100</span>%</label>
							<input type="range" id="volumeSlider" min="0" max="100" value="100">
						</div>

						<div class="settings-group slider-container">
							<label>Speed: <span class="slider-value" id="rateValue">1.0</span></label>
							<input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
						</div>

						<div class="settings-group slider-container">
							<label>Pitch: <span class="slider-value" id="pitchValue">1.0</span></label>
							<input type="range" id="pitchSlider" min="0" max="2" step="0.1" value="1">
						</div>
					</div>
				</div>
			</div>

            
            <div class="status" id="status">Status: Not listening</div>
            
            <div class="faction-selector">
                <div class="faction-group active" id="standardFaction">
                    <h3>Standard Forces</h3>
                    <div class="faction-list">
                        • US Forces<br>
                        • UK/Commonwealth<br>
                        • German Forces
                    </div>
                </div>
                <div class="faction-group" id="russianFaction">
                    <h3>Russian Forces</h3>
                    <div class="faction-list">
                        • Different artillery calculation<br>
                        • Specific elevation formula
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3>Enter Distance</h3>
                <div class="input-group">
                    <input type="number" id="metersInput" placeholder="Enter distance in meters" min="0" max="9999">
                    <button id="calculateBtn">Calculate</button>
                </div>
            </div>
            
            <div class="conversion" id="conversion">Waiting for input...</div>
            
            <div class="history">
                <h3>Calculation History</h3>
                <div id="historyList"></div>
            </div>

            <div class="voice-info">
                <h3>Voice Recognition Information</h3>
                <p>Voice commands work in the background even when alt-tabbed.</p>
                
                <div class="browser-support">
                    <div class="browser-item">
                        <strong>Chrome</strong><br>
                        <span class="supported">✓ Fully Supported</span>
                    </div>
                    <div class="browser-item">
                        <strong>Edge</strong><br>
                        <span class="supported">✓ Fully Supported</span>
                    </div>
                    <div class="browser-item">
                        <strong>Safari</strong><br>
                        <span class="unsupported">✗ Limited Support</span>
                    </div>
                    <div class="browser-item">
                        <strong>Firefox</strong><br>
                        <span class="unsupported">✗ Not Supported</span>
                    </div>
                </div>

                <div class="commands">
                    <h3>Voice Commands:</h3>
                    <p>1. Set faction: "<strong>faction russian</strong>" or "<strong>faction standard</strong>"</p>
                    <p>2. Calculate: Say a number followed by "meters" (e.g., "<strong>400 meters</strong>")</p>
                    <p><strong>Note:</strong> For best results, use Chrome or Edge with a clear microphone</p>
                </div>
            </div>
            
        </div>
    </div>

    <script>
let currentFaction = 'standard';
let calculationHistory = [];
let micPermissionGranted = false;

// Audio settings object
const audioSettings = {
	enabled: true,
	voice: 'UK English Female',
	volume: 1,
	rate: 1,
	pitch: 1
};

// Available ResponsiveVoice voices
const rvVoices = [
	'UK English Female',
	'UK English Male',
	'US English Female',
	'US English Male',
	'Australian Female'
];

// Initialize settings
function initSettings() {
	// Load from localStorage
	const savedSettings = localStorage.getItem('audioSettings');
	if (savedSettings) {
		Object.assign(audioSettings, JSON.parse(savedSettings));
	}

	// Set UI elements
	document.getElementById('audioEnabled').checked = audioSettings.enabled;
	document.getElementById('volumeSlider').value = audioSettings.volume * 100;
	document.getElementById('rateSlider').value = audioSettings.rate;
	document.getElementById('pitchSlider').value = audioSettings.pitch;
	updateSliderValues();

	// Populate voice select
	const voiceSelect = document.getElementById('voiceSelect');
	rvVoices.forEach(voice => {
		const option = document.createElement('option');
		option.value = voice;
		option.textContent = voice;
		voiceSelect.appendChild(option);
	});
	voiceSelect.value = audioSettings.voice;

	// Initialize Web Speech voices
	initWebSpeechVoices();
}

// Initialize Web Speech API voices
function initWebSpeechVoices() {
	if ('speechSynthesis' in window) {
		speechSynthesis.onvoiceschanged = () => {
			const voices = speechSynthesis.getVoices();
			const voiceSelect = document.getElementById('voiceSelect');
			
			voices.filter(v => v.lang.startsWith('en-')).forEach(voice => {
				const option = document.createElement('option');
				option.value = voice.name;
				option.textContent = `${voice.name} (${voice.lang})`;
				voiceSelect.appendChild(option);
			});
		};
	}
}

// Save settings to localStorage
function saveSettings() {
	audioSettings.enabled = document.getElementById('audioEnabled').checked;
	audioSettings.voice = document.getElementById('voiceSelect').value;
	audioSettings.volume = parseFloat(document.getElementById('volumeSlider').value) / 100;
	audioSettings.rate = parseFloat(document.getElementById('rateSlider').value);
	audioSettings.pitch = parseFloat(document.getElementById('pitchSlider').value);
	
	localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
}

// Update slider display values
function updateSliderValues() {
	document.getElementById('volumeValue').textContent = 
		Math.round(document.getElementById('volumeSlider').value);
	document.getElementById('rateValue').textContent = 
		document.getElementById('rateSlider').value;
	document.getElementById('pitchValue').textContent = 
		document.getElementById('pitchSlider').value;
        }

// Standard conversion for US, UK, and German forces
const standardConversion = (meters) => {
	const A = 1001.465;
	const B = -0.2371;
	return Math.round(A + (B * meters));
};

// Russian conversion
const russianConversion = (meters) => {
	const A = 1120;
	const B = 21.33;
	const L = 100;
	return Math.round(A - (((meters / L) - 1) * B));
};
// Load settings and history from localStorage
function loadSettings() {
    const savedFaction = localStorage.getItem('currentFaction');
    const savedAudioEnabled = localStorage.getItem('audioEnabled');
    const savedHistory = localStorage.getItem('calculationHistory');

    if (savedFaction) currentFaction = savedFaction;
    if (savedAudioEnabled) audioEnabled = JSON.parse(savedAudioEnabled);
    if (savedHistory) calculationHistory = JSON.parse(savedHistory);

    updateFactionUI(currentFaction);
    updateHistoryUI();
    document.getElementById('audioBtn').textContent = audioEnabled ? 'Sound enabled' : 'Sound disabled';
}

// Save settings and history to localStorage
function saveSettings() {
    localStorage.setItem('currentFaction', currentFaction);
    localStorage.setItem('audioEnabled', JSON.stringify(audioEnabled));
    localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
}

// Clear history
function clearHistory() {
    calculationHistory = [];
    updateHistoryUI();
    saveSettings();
}

// Update faction UI
function updateFactionUI(faction) {
    document.getElementById('standardFaction').classList.remove('active');
    document.getElementById('russianFaction').classList.remove('active');
    if (faction === 'standard') {
        document.getElementById('standardFaction').classList.add('active');
    } else {
        document.getElementById('russianFaction').classList.add('active');
    }
}

// Add to history
function addToHistory(meters, mils, faction) {
    calculationHistory.unshift({
        meters,
        mils,
        faction,
        timestamp: new Date().toLocaleTimeString()
    });
    if (calculationHistory.length > 10) calculationHistory.pop();
    updateHistoryUI();
    saveSettings();
}

// Update history UI
function updateHistoryUI() {
    const historyHTML = calculationHistory.map(item => `
        <div class="history-item">
            <span>${item.timestamp} - ${item.faction}</span>
            <span>${item.meters}m = ${item.mils} mils</span>
        </div>
    `).join('');
    document.getElementById('historyList').innerHTML = historyHTML;
}

// Calculate mils
function calculateMils(meters) {
    if (isNaN(meters) || meters < 0) return null;

    let mils;
    if (currentFaction === 'russian') {
        mils = russianConversion(meters);
    } else {
        mils = standardConversion(meters);
    }

    document.getElementById('conversion').textContent = `${meters} meters = ${mils} mils`;
    addToHistory(meters, mils, currentFaction);

    if ('speechSynthesis' in window) {
        speak(`${mils} mils`);
    }

    return mils;
}

// Request microphone permission
async function requestMicrophonePermission() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micPermissionGranted = true;
        stream.getTracks().forEach(track => track.stop());
        return true;
    } catch (err) {
        console.error('Microphone permission denied:', err);
        document.getElementById('status').textContent = 'Status: Microphone access denied';
        document.getElementById('startBtn').disabled = true;
        return false;
    }
}

// Update button states
function updateButtonStates(isListening) {
    document.getElementById('startBtn').disabled = isListening;
    document.getElementById('stopBtn').disabled = !isListening;
}

// Setup keyboard input
document.getElementById('calculateBtn').addEventListener('click', () => {
    const meters = parseInt(document.getElementById('metersInput').value);
    calculateMils(meters);
});

document.getElementById('metersInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const meters = parseInt(e.target.value);
        calculateMils(meters);
    }
});

// Faction selection
document.getElementById('standardFaction').addEventListener('click', () => {
    currentFaction = 'standard';
    updateFactionUI('standard');
    saveSettings();
});

document.getElementById('russianFaction').addEventListener('click', () => {
    currentFaction = 'russian';
    updateFactionUI('russian');
    saveSettings();
});


// Speak function with fallback
function speak(text) {
	if (!audioSettings.enabled) return;

	try {
		// Try ResponsiveVoice first
		if (typeof responsiveVoice !== 'undefined') {
			responsiveVoice.speak(text, audioSettings.voice, {
				volume: audioSettings.volume,
				rate: audioSettings.rate,
				pitch: audioSettings.pitch
			});
		} 
		// Fallback to Web Speech API
		else if ('speechSynthesis' in window) {
			const utterance = new SpeechSynthesisUtterance(text);
			const voices = speechSynthesis.getVoices();
			const voice = voices.find(v => v.name === audioSettings.voice);
			
			if (voice) utterance.voice = voice;
			utterance.volume = audioSettings.volume;
			utterance.rate = audioSettings.rate;
			utterance.pitch = audioSettings.pitch;
			
			speechSynthesis.speak(utterance);
		}
	} catch (e) {
		console.error('Speech error:', e);
	}
}



// Clear history button
document.getElementById('clearHistoryBtn').addEventListener('click', () => {
    clearHistory();
});

// Voice recognition setup
if (annyang) {
    const commands = {
        'faction *team': function(team) {
            const teamLower = team.toLowerCase();
            if (teamLower === 'russian') {
                currentFaction = 'russian';
                updateFactionUI('russian');
                if (audioEnabled) {
                    speak('Russian faction selected');
                }
            } else if (teamLower === 'standard' || ['us', 'uk', 'german'].includes(teamLower)) {
                currentFaction = 'standard';
                updateFactionUI('standard');
                if (audioEnabled) {
                    speak('Standard faction selected');
                }
            }
            saveSettings();
        },
        ':number meters': function(number) {
            const meters = parseInt(number);
            calculateMils(meters);
        },
        ':number': function(number) {
            const meters = parseInt(number);
            calculateMils(meters);
        }
    };

    annyang.addCommands(commands);

    // Start button handler
    document.getElementById('startBtn').addEventListener('click', async () => {
        if (!micPermissionGranted) {
            const permitted = await requestMicrophonePermission();
            if (!permitted) return;
        }

        annyang.start({ autoRestart: true, continuous: true });
        document.getElementById('status').textContent = 'Status: Listening';
        updateButtonStates(true);
    });

    // Stop button handler
    document.getElementById('stopBtn').addEventListener('click', () => {
        annyang.abort();
        document.getElementById('status').textContent = 'Status: Not listening';
        updateButtonStates(false);
    });
	document.getElementById('audioEnabled').addEventListener('change', saveSettings);
	document.getElementById('voiceSelect').addEventListener('change', saveSettings);
	document.getElementById('volumeSlider').addEventListener('input', () => {
		updateSliderValues();
		saveSettings();
	});
	document.getElementById('rateSlider').addEventListener('input', () => {
		updateSliderValues();
		saveSettings();
	});
	document.getElementById('pitchSlider').addEventListener('input', () => {
		updateSliderValues();
		saveSettings();
	});
    // Error handling
    annyang.addCallback('error', function(err) {
        console.error('Annyang error:', err);
        if (err.error === 'network') {
            document.getElementById('status').textContent = 'Status: Network error - check connection';
        } else if (err.error === 'audio') {
            document.getElementById('status').textContent = 'Status: Audio error - check microphone';
            micPermissionGranted = false;
        } else if (err.error === 'aborted') {
            document.getElementById('status').textContent = 'Status: Recognition stopped';
            updateButtonStates(false);
            return;
        } else {
            document.getElementById('status').textContent = 'Status: Error occurred';
        }
        updateButtonStates(false);
    });

    // Handle successful start
    annyang.addCallback('start', function() {
        micPermissionGranted = true;
        document.getElementById('status').textContent = 'Status: Listening';
        updateButtonStates(true);
    });
} else {
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('status').textContent = 'Voice recognition not available';
}

// Set initial button states
updateButtonStates(false);
document.getElementById('audioBtn').textContent = audioEnabled ? 'Sound enabled' : 'Sound disabled';

// Load settings on page load
loadSettings();

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        if (annyang && annyang.isListening()) {
            document.getElementById('status').textContent = 'Status: Running in background';
        }
    } else {
        if (annyang && annyang.isListening()) {
            document.getElementById('status').textContent = 'Status: Listening';
            updateButtonStates(true);
        } else {
            document.getElementById('status').textContent = 'Status: Not listening';
            updateButtonStates(false);
        }
    }
});
	

// Only request notification permission once
if ('Notification' in window && Notification.permission === 'default') {
	Notification.requestPermission();
}
    </script>
</body>
</html>