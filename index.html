<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLL Range Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #333;
        }
        .faction-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .faction-group {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .faction-group.active {
            background: #4CAF50;
        }
        .faction-group h3 {
            margin: 0 0 10px 0;
        }
        .faction-list {
            font-size: 0.9em;
            color: #ccc;
        }
        .conversion {
            font-size: 24px;
            padding: 20px;
            margin: 10px 0;
            border-radius: 4px;
            background: #555;
            text-align: center;
        }
        .history {
            margin-top: 20px;
            background: #333;
            padding: 15px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .commands {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
		input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: white;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-section {
            margin: 20px 0;
            padding: 20px;
            background: #333;
            border-radius: 4px;
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .voice-info {
            background: #444;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }

        .voice-info h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .browser-support {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .browser-item {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .supported {
            color: #4CAF50;
        }

        .unsupported {
            color: #ff4444;
        }

        /* Rest of the previous styles remain the same */
    </style>
</head>
<body>
    <div class="container">
        <div class="calculator">
            <h1>Hell Let Loose Artillery Calculator</h1>
            
            <div class="control-panel">
                <button id="startBtn">Start Voice</button>
                <button id="stopBtn" disabled=true>Stop Voice</button>
				<button id="audioBtn">Sound enabled</button>

            </div>
            
            <div class="status" id="status">Status: Not listening</div>
            
            <div class="faction-selector">
                <div class="faction-group active" id="standardFaction">
                    <h3>Standard Forces</h3>
                    <div class="faction-list">
                        • US Forces<br>
                        • UK/Commonwealth<br>
                        • German Forces
                    </div>
                </div>
                <div class="faction-group" id="russianFaction">
                    <h3>Russian Forces</h3>
                    <div class="faction-list">
                        • Different artillery calculation<br>
                        • Specific elevation formula
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3>Enter Distance</h3>
                <div class="input-group">
                    <input type="number" id="metersInput" placeholder="Enter distance in meters" min="0" max="9999">
                    <button id="calculateBtn">Calculate</button>
                </div>
            </div>
            
            <div class="conversion" id="conversion">Waiting for input...</div>
            
            <div class="history">
                <h3>Calculation History</h3>
                <div id="historyList"></div>
            </div>

            <div class="voice-info">
                <h3>Voice Recognition Information</h3>
                <p>Voice commands work in the background even when alt-tabbed.</p>
                
                <div class="browser-support">
                    <div class="browser-item">
                        <strong>Chrome</strong><br>
                        <span class="supported">✓ Fully Supported</span>
                    </div>
                    <div class="browser-item">
                        <strong>Edge</strong><br>
                        <span class="supported">✓ Fully Supported</span>
                    </div>
                    <div class="browser-item">
                        <strong>Safari</strong><br>
                        <span class="unsupported">✗ Limited Support</span>
                    </div>
                    <div class="browser-item">
                        <strong>Firefox</strong><br>
                        <span class="unsupported">✗ Not Supported</span>
                    </div>
                </div>

                <div class="commands">
                    <h3>Voice Commands:</h3>
                    <p>1. Set faction: "<strong>faction russian</strong>" or "<strong>faction standard</strong>"</p>
                    <p>2. Calculate: Say a number followed by "meters" (e.g., "<strong>400 meters</strong>")</p>
                    <p><strong>Note:</strong> For best results, use Chrome or Edge with a clear microphone</p>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        let currentFaction = 'standard';
        let calculationHistory = [];
        let micPermissionGranted = false;
		let audioEnabled = true;
            
        // Standard conversion for US, UK, and German forces
        const standardConversion = (meters) => {
            const A = 1001.465;
            const B = -0.2371;
            return Math.round(A + (B * meters));
        };

        // Russian conversion
        const russianConversion = (meters) => {
            const A = 1120;
            const B = 21.33;
            const L = 100;
            return Math.round(A - (((meters / L) - 1) * B));
        };

        // Previous UI update functions remain the same
        function updateFactionUI(faction) {
            document.getElementById('standardFaction').classList.remove('active');
            document.getElementById('russianFaction').classList.remove('active');
            if (faction === 'standard') {
                document.getElementById('standardFaction').classList.add('active');
            } else {
                document.getElementById('russianFaction').classList.add('active');
            }
        }

        function addToHistory(meters, mils, faction) {
            calculationHistory.unshift({
                meters,
                mils,
                faction,
                timestamp: new Date().toLocaleTimeString()
            });
            if (calculationHistory.length > 10) calculationHistory.pop();
            updateHistoryUI();
        }

        function updateHistoryUI() {
            const historyHTML = calculationHistory.map(item => `
                <div class="history-item">
                    <span>${item.timestamp} - ${item.faction}</span>
                    <span>${item.meters}m = ${item.mils} mils</span>
                </div>
            `).join('');
            document.getElementById('historyList').innerHTML = historyHTML;
        }

        function calculateMils(meters) {
            if (isNaN(meters) || meters < 0) return null;
            
            let mils;
            if (currentFaction === 'russian') {
                mils = russianConversion(meters);
            } else {
                mils = standardConversion(meters);
            }
            
            document.getElementById('conversion').textContent = 
                `${meters} meters = ${mils} mils`;
            addToHistory(meters, mils, currentFaction);
            
            if (audioEnabled && 'speechSynthesis' in window) {
                speak(`${mils} mils`);
            }
            
            return mils;
        }
        // New microphone permission handling
        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                micPermissionGranted = true;
                // Stop the stream immediately as we don't need it
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (err) {
                console.error('Microphone permission denied:', err);
                document.getElementById('status').textContent = 'Status: Microphone access denied';
                document.getElementById('startBtn').disabled = true;
                return false;
            }
        }

        // Setup keyboard input
        document.getElementById('calculateBtn').addEventListener('click', () => {
            const meters = parseInt(document.getElementById('metersInput').value);
            calculateMils(meters);
        });

        document.getElementById('metersInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const meters = parseInt(e.target.value);
                calculateMils(meters);
            }
        });

        // Add click handlers for faction selection
        document.getElementById('standardFaction').addEventListener('click', () => {
            currentFaction = 'standard';
            updateFactionUI('standard');
        });

        document.getElementById('russianFaction').addEventListener('click', () => {
            currentFaction = 'russian';
            updateFactionUI('russian');
        });

        // Speech synthesis setup
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utterance);
            }
        }

        // Voice recognition setup
        if (annyang) {
            const commands = {
                'faction *team': function(team) {
                    const teamLower = team.toLowerCase();
                    if (teamLower === 'russian') {
                        currentFaction = 'russian';
                        updateFactionUI('russian');
						if (audioEnabled) {
							speak('Russian faction selected');
						}
                    } else if (teamLower === 'standard' || ['us', 'uk', 'german'].includes(teamLower)) {
                        currentFaction = 'standard';
                        updateFactionUI('standard');
						if (audioEnabled) {
							speak('Standard faction selected');
						}
                    }
                },
                ':number meters': function(number) {
                    const meters = parseInt(number);
                    calculateMils(meters);
                },
				':number': function(number) {
                    const meters = parseInt(number);
                    calculateMils(meters);
                }
            };

            annyang.addCommands(commands);
            document.getElementById('audioBtn').addEventListener('click', async () => {
                audioEnabled = !audioEnabled
               
				if (audioEnabled) {
					document.getElementById('audioBtn').textContent = 'Sound enabled';
				} else {
					document.getElementById('audioBtn').textContent = 'Sound disabled';
				}
            });
            // Modified start button handler
            document.getElementById('startBtn').addEventListener('click', async () => {
                if (!micPermissionGranted) {
                    const permitted = await requestMicrophonePermission();
                    if (!permitted) return;
                }
                
                annyang.start({ autoRestart: true, continuous: true });
                document.getElementById('status').textContent = 'Status: Listening';
				document.getElementById('startBtn').disabled = true;
				document.getElementById('stopBtn').disabled = false;

            });

            document.getElementById('stopBtn').addEventListener('click', () => {
                annyang.abort();
                document.getElementById('status').textContent = 'Status: Not listening';
				document.getElementById('startBtn').disabled = false;
				document.getElementById('stopBtn').disabled = true;

            });

            // Modified error handling
            annyang.addCallback('error', function(err) {
                console.error('Annyang error:', err);
                if (err.error === 'network') {
                    document.getElementById('status').textContent = 'Status: Network error - check connection';
                } else if (err.error === 'audio') {
                    document.getElementById('status').textContent = 'Status: Audio error - check microphone';
                    micPermissionGranted = false;
                } else {
                    document.getElementById('status').textContent = 'Status: Error occurred';
                }
				document.getElementById('startBtn').disabled = false;
				document.getElementById('stopBtn').disabled = true;

            });

            // Handle successful start
            annyang.addCallback('start', function() {
                micPermissionGranted = true;
                document.getElementById('status').textContent = 'Status: Listening';
				document.getElementById('startBtn').disabled = true;
				document.getElementById('stopBtn').disabled = false;


            });
        } else {
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = 'Voice recognition not available';
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (annyang && annyang.isListening()) {
                    document.getElementById('status').textContent = 'Status: Running in background';
                }
            } else {
                if (annyang && annyang.isListening()) {
                    document.getElementById('status').textContent = 'Status: Listening';
                } else {
                    document.getElementById('status').textContent = 'Status: Not listening';
                }
            }
        });

        // Only request notification permission once
        //if ('Notification' in window && Notification.permission === 'default') {
            //Notification.requestPermission();
        //}
    </script>
</body>
</html>